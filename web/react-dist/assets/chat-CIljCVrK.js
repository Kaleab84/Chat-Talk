import{j as e,r as l,g as R,c as _,R as J}from"./styles-D9vFcHhE.js";function W({attachments:n=[],onImageClick:i}){return n.length?e.jsx("div",{className:"img-grid",children:n.map(s=>e.jsx("button",{type:"button",className:"img-grid-btn",onClick:()=>i==null?void 0:i(s),children:e.jsx("img",{src:s.previewUrl,alt:s.name||"attachment"})},s.id))}):null}function K({message:n,onImageClick:i}){const s=n.role==="user"?"user":"bot",c=["msg",s];n.isTyping&&c.push("typing"),n.isError&&c.push("err"),n.isStreaming&&c.push("streaming");const k=n.isTyping?e.jsxs("span",{className:"typing-text",children:["Assistant is thinking",e.jsx("span",{className:"dots"})]}):n.text||"";return e.jsxs("div",{className:c.join(" "),children:[e.jsx("p",{className:"msg-text",children:k}),s==="user"&&Array.isArray(n.attachments)&&n.attachments.length?e.jsx(W,{attachments:n.attachments,onImageClick:i}):null,n.timestamp?e.jsx("div",{className:"meta",children:n.timestamp}):null]})}function V({messages:n=[],onImageClick:i}){const s=l.useRef(null);return l.useEffect(()=>{const c=s.current;c&&(c.scrollTop=c.scrollHeight)},[n]),e.jsx("div",{className:"thread",ref:s,"aria-live":"polite","aria-relevant":"additions",children:n.map(c=>e.jsx(K,{message:c,onImageClick:i},c.id))})}function X({attachments:n=[],onRemove:i}){return n.length?e.jsx("div",{className:"attachment-strip",children:n.map(s=>e.jsxs("div",{className:"attachment-chip",children:[e.jsx("img",{src:s.previewUrl,alt:s.name||"attachment"}),e.jsxs("div",{className:"attachment-meta",children:[e.jsx("div",{className:"attachment-name",children:s.name||"Attachment"}),e.jsx("button",{type:"button",onClick:()=>i==null?void 0:i(s.id),"aria-label":`Remove ${s.name||"attachment"}`,children:"×"})]})]},s.id))}):null}function Y({image:n,onClose:i}){return l.useEffect(()=>{if(!n)return;const s=c=>{c.key==="Escape"&&(i==null||i())};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[n,i]),e.jsx("div",{className:`img-modal ${n?"active":""}`,onClick:()=>i==null?void 0:i(),role:"dialog","aria-label":"Image preview","aria-modal":"true",children:n?e.jsx("img",{src:n.previewUrl,alt:n.name||"attachment preview",onClick:s=>s.stopPropagation()}):null})}const L=()=>{const n=typeof globalThis<"u"?globalThis.crypto:null;return n!=null&&n.randomUUID?n.randomUUID():`msg-${Date.now()}-${Math.random().toString(16).slice(2)}`},S=()=>new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});function Z(){const[n,i]=l.useState(()=>R()),[s,c]=l.useState(""),[k,p]=l.useState([]),[v,w]=l.useState([]),[T,U]=l.useState(!1),[C,E]=l.useState(null),N=l.useRef(null),x=l.useRef(new Map);l.useEffect(()=>{i(R())},[]),l.useEffect(()=>()=>{x.current.forEach(t=>clearTimeout(t)),x.current.clear()},[]);const $=l.useCallback(t=>{if(!(t!=null&&t.length))return;const r=t.map(o=>({id:L(),name:o.name||"attachment",previewUrl:URL.createObjectURL(o),file:o}));w(o=>[...o,...r])},[]),D=t=>{const r=Array.from(t.target.files||[]);$(r),t.target.value=""},I=t=>{w(r=>{const o=r.find(u=>u.id===t);if(o!=null&&o.previewUrl)try{URL.revokeObjectURL(o.previewUrl)}catch{}return r.filter(u=>u.id!==t)})},B=()=>{w([])},y=l.useCallback(t=>{const r=x.current.get(t);r&&(clearTimeout(r),x.current.delete(t))},[]),F=l.useCallback((t,r,o={})=>{const u=typeof r=="string"?r:r!=null?String(r):"",a=Array.from(u),g=o.timestamp??S();if(p(b=>b.map(h=>h.id===t?{...h,...o,text:"",isTyping:!1,isStreaming:!0,timestamp:g}:h)),!a.length){p(b=>b.map(h=>h.id===t?{...h,text:"",isStreaming:!1}:h));return}const d=a.length<80?1:a.length<400?2:3,f=a.length>400?15:19;let j=0;const M=()=>{const b=Math.min(a.length,j+d),h=a.slice(j,b).join("");if(j=b,p(A=>A.map(m=>m.id===t?{...m,text:`${m.text||""}${h}`}:m)),j>=a.length){p(A=>A.map(m=>m.id===t?{...m,isStreaming:!1}:m)),y(t);return}const H=f+Math.random()*f,Q=setTimeout(M,H);x.current.set(t,Q)};y(t);const z=setTimeout(M,40);x.current.set(t,z)},[y]),O=async()=>{const t=s.trim(),r=v;if(!t&&!r.length)return;const o={id:L(),role:"user",text:t,attachments:r.map(a=>({id:a.id,name:a.name,previewUrl:a.previewUrl})),timestamp:S()},u=L();p(a=>[...a,o,{id:u,role:"assistant",text:"Assistant is thinking…",isTyping:!0}]),c(""),U(!0),w([]);try{let a;if(r.length){const d=new FormData;d.append("question",t),d.append("top_k","4"),r.forEach(j=>d.append("images",j.file)),a=await(await fetch("/ask-with-media",{method:"POST",body:d})).json()}else a=await(await fetch("/ask",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({question:t,top_k:4})})).json();const g=a!=null&&a.success?a.answer||"No answer provided yet.":(a==null?void 0:a.detail)||"Request failed.";a!=null&&a.success?F(u,g,{isError:!1}):(y(u),p(d=>d.map(f=>f.id===u?{...f,text:g,isTyping:!1,isError:!0,timestamp:S()}:f)))}catch(a){y(u),p(g=>g.map(d=>d.id===u?{...d,text:String(a),isTyping:!1,isError:!0,timestamp:S()}:d))}finally{U(!1),B(),N.current&&(N.current.value="")}},P=t=>{t.preventDefault(),O()},q=t=>E(t),G=()=>E(null);return e.jsxs("div",{className:"react-app",children:[e.jsxs("header",{className:"container header react-header",children:[e.jsx("div",{className:"brand",children:"CFC Software Support"}),e.jsx("div",{className:"greet",children:n?`Hi, ${n}!`:"Welcome back"})]}),e.jsx("main",{className:"container chat-container",children:e.jsx("section",{className:"panel active chat-panel",children:e.jsxs("div",{className:"panel-body chat-panel-body",children:[e.jsx("h2",{children:"Chat with AI Assistant"}),e.jsx(V,{messages:k,onImageClick:q}),e.jsx(X,{attachments:v,onRemove:I}),e.jsxs("form",{className:"chat-input react-chat-input",onSubmit:P,children:[e.jsx("input",{type:"text",placeholder:"Ask anything about CFC software…",value:s,onChange:t=>c(t.target.value),disabled:T}),e.jsx("input",{ref:N,type:"file",accept:"image/*",multiple:!0,hidden:!0,onChange:D}),e.jsx("button",{type:"button",className:"btn icon",onClick:()=>{var t;return(t=N.current)==null?void 0:t.click()},"aria-label":"Attach images",disabled:T,children:e.jsx("svg",{viewBox:"0 0 24 24","aria-hidden":"true",focusable:"false",children:e.jsx("path",{d:"M21 8.5l-9.19 9.19a5 5 0 01-7.07 0h0a5 5 0 010-7.07L13.5 1.75a3.5 3.5 0 114.95 4.95L8.3 16.86a2 2 0 01-2.83 0h0a2 2 0 010-2.83L15.2 4.31",fill:"none",strokeLinecap:"round",strokeLinejoin:"round"})})}),e.jsx("button",{className:"btn icon",type:"submit",disabled:T,"aria-label":"Send message",children:e.jsx("svg",{viewBox:"0 0 24 24","aria-hidden":"true",focusable:"false",children:e.jsx("path",{d:"M3 11.5l18-8-8 18-2.5-6.5L3 11.5z",fill:"none",strokeLinecap:"round",strokeLinejoin:"round"})})})]}),e.jsx("div",{className:"meta",children:v.length?`${v.length} image${v.length>1?"s":""} ready to send`:"Images are optional. Upload screenshots for richer answers."})]})})}),e.jsx("footer",{className:"container footer",children:e.jsx("a",{className:"btn",href:"/ui/login.html","aria-label":"Back to Login",children:"Back to Login"})}),e.jsx(Y,{image:C,onClose:G})]})}_.createRoot(document.getElementById("root")).render(e.jsx(J.StrictMode,{children:e.jsx(Z,{})}));
